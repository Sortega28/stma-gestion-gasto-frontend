<div class="alertas-container">

  <h2>Alertas de Contratación</h2>

  <div class="regenerar-wrapper">
    <button mat-raised-button color="warn" (click)="regenerarAlertas()">
      Regenerar alertas del año
    </button>
  </div>

  <div class="filtros">

    <mat-form-field appearance="outline">
      <mat-label>Proveedor</mat-label>
      <input matInput [(ngModel)]="filtros.proveedor" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Objeto</mat-label>
      <mat-select [(ngModel)]="filtros.objeto">
        <mat-option value="">Todos</mat-option>
        <mat-option value="Servicio">Servicio</mat-option>
        <mat-option value="Suministro">Suministro</mat-option>
        <mat-option value="Obra">Obra</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Tipo alerta</mat-label>
      <mat-select [(ngModel)]="filtros.tipo_alerta">
        <mat-option value="">Todas</mat-option>
        <mat-option value="FRACCIONAMIENTO">Fraccionamiento</mat-option>
        <mat-option value="LIMITE_CONTRATO">Límite contrato</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-checkbox [(ngModel)]="filtros.noRevisadas">
      Solo no revisadas
    </mat-checkbox>

    <button 
      mat-flat-button 
      color="primary" 
      class="btn-buscar" 
      (click)="buscar()">
      <mat-icon>search</mat-icon> Buscar
    </button>

  </div>

  <div *ngIf="loading" class="loading">Cargando alertas...</div>

  <div class="tabla" *ngIf="!loading">

    <table 
      mat-table 
      [dataSource]="dataSource" 
      class="mat-elevation-z2">

      <!-- PROVEEDOR -->
      <ng-container matColumnDef="proveedor">
        <th mat-header-cell *matHeaderCellDef>Proveedor</th>
        <td mat-cell *matCellDef="let a">{{ a.proveedor }}</td>
      </ng-container>

      <!-- OBJETO -->
      <ng-container matColumnDef="objeto">
        <th mat-header-cell *matHeaderCellDef>Objeto</th>
        <td mat-cell *matCellDef="let a">{{ a.objeto }}</td>
      </ng-container>

      <!-- ACUMULADO POR OBJETO -->
      <ng-container matColumnDef="importe_objeto">
        <th mat-header-cell *matHeaderCellDef>
          Acumulado anual (por objeto)
        </th>
        <td mat-cell *matCellDef="let a">{{ a.gasto_anual | currency:'EUR' }}</td>
      </ng-container>

      <!-- UMBRAL -->
      <ng-container matColumnDef="umbral">
        <th mat-header-cell *matHeaderCellDef>Umbral</th>
        <td mat-cell *matCellDef="let a">{{ a.umbral | currency:'EUR' }}</td>
      </ng-container>

      <!-- TIPO ALERTA -->
      <ng-container matColumnDef="tipo_alerta">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let a">{{ a.tipo_alerta }}</td>
      </ng-container>

      <!-- ACCIONES -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let a">

          <span *ngIf="a.revisada" class="badge-revisada">
            ✔ Revisada
          </span>

          <button 
            mat-stroked-button 
            color="primary"
            *ngIf="!a.revisada && (roleService.esAdmin() || roleService.esAuditor())"
            (click)="marcarRevisada(a.id)">
            Marcar revisada
          </button>

        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="cols"></tr>
      <tr mat-row *matRowDef="let row; columns: cols"></tr>

    </table>

  </div>

  <div class="paginacion" *ngIf="totalPages > 1">
    
    <button 
      mat-stroked-button 
      (click)="anterior()" 
      [disabled]="page === 1">
      ◀ Anterior
    </button>

    <span>Página {{ page }} de {{ totalPages }}</span>

    <button 
      mat-stroked-button 
      (click)="siguiente()"
      [disabled]="page >= totalPages">
      Siguiente ▶
    </button>

  </div>

</div>
